<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Kürtçe Fiil Çekimi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { min-height: 100vh; }
  </style>
</head>
<body class="min-h-screen bg-blue-50 text-gray-800 flex flex-col items-center justify-start p-6 gap-6">

  <h1 class="text-3xl font-bold text-blue-800">Kürtçe Fiil Çekimi</h1>

  <input
    type="text"
    id="verb-search"
    placeholder="Fiil ara (Kürtçe ya da Türkçe)..."
    class="rounded-md border border-blue-300 p-2 text-gray-700 max-w-xs"
  />

  <label for="verb-select" class="font-semibold text-blue-700">Fiil seçin:</label>
  <select id="verb-select" class="rounded-md border border-blue-300 p-2 text-gray-700 max-w-xs">
    <!-- options will be populated dynamically -->
  </select>

  <div id="conjugation-container" class="max-w-4xl w-full bg-white rounded-2xl shadow-xl p-6 space-y-6">
    <!-- conjugation table will appear here -->
  </div>

  <script>
    const persons = ["ez", "tu", "ew", "em", "hûn", "ew (pl.)"];
    const verbSelect = document.getElementById("verb-select");
    const searchInput = document.getElementById("verb-search");
    const conjugationContainer = document.getElementById("conjugation-container");

    let verbs = {};

    // Normalize special characters for search to plain ascii letters
    function normalizeForSearch(str) {
      return str
        .toLowerCase()
        .replace(/[\u0131îíìï]/g, 'i')  // ı, î, í, ì, ï → i
        .replace(/ş/g, 's')
        .replace(/ç/g, 'c')
        .replace(/ğ/g, 'g')
        .replace(/ü/g, 'u')
        .replace(/ö/g, 'o')
        .replace(/ê/g, 'e')
        .replace(/û/g, 'u')
        .replace(/á/g, 'a')
        .replace(/é/g, 'e')
        .replace(/â/g, 'a')
        // Add more replacements here if needed
        ;
    }

    fetch('Kurdish_Verbs.csv')
      .then(response => response.text())
      .then(csvText => {
        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        buildVerbsObject(parsed.data);
        populateDropdown();
        renderTable(verbSelect.value);
      })
      .catch(err => {
        conjugationContainer.innerHTML = "<p class='text-red-600'>CSV dosyası yüklenirken hata oluştu.</p>";
        console.error("Error loading CSV:", err);
      });

    function buildVerbsObject(data) {
      data.forEach(row => {
        verbs[row.verb] = {
          definition: row.definition,
          root: row.root,
          conjugations: {
            present: [
              row.present_1, row.present_2, row.present_3,
              row.present_4, row.present_5, row.present_6
            ],
            presentNegative: [
              row.presentNegative_1, row.presentNegative_2, row.presentNegative_3,
              row.presentNegative_4, row.presentNegative_5, row.presentNegative_6
            ],
            past: [
              row.past_1, row.past_2, row.past_3,
              row.past_4, row.past_5, row.past_6
            ],
            future: [
              row.future_1, row.future_2, row.future_3,
              row.future_4, row.future_5, row.future_6
            ]
          }
        };
      });
    }

    function populateDropdown(filter = "") {
      const query = normalizeForSearch(filter);
      verbSelect.innerHTML = "";

      const matches = Object.entries(verbs).filter(([verb, data]) => {
        const normVerb = normalizeForSearch(verb);
        const normDef = normalizeForSearch(data.definition);

        // Check verb or definition
        if (normVerb.includes(query) || normDef.includes(query)) return true;

        // Check all conjugated forms for match
        return Object.values(data.conjugations).some(tenseArray =>
          tenseArray.some(form => form && normalizeForSearch(form).includes(query))
        );
      });

      if (matches.length === 0) {
        const option = document.createElement("option");
        option.textContent = "Eşleşen fiil bulunamadı.";
        option.disabled = true;
        verbSelect.appendChild(option);
        conjugationContainer.innerHTML = "";
        return;
      }

      matches.forEach(([verb, data], index) => {
        const option = document.createElement("option");
        option.value = verb;
        option.textContent = `${verb} (${data.definition})`;
        verbSelect.appendChild(option);
        if (index === 0) renderTable(verb);
      });
    }

    function renderTable(verb) {
      if (!verb || !verbs[verb]) {
        conjugationContainer.innerHTML = "<p>Fiil seçiniz.</p>";
        return;
      }
      const v = verbs[verb].conjugations;
      const root = verbs[verb].root || "";
      conjugationContainer.innerHTML = `
        <h2 class="text-xl font-semibold text-blue-700 flex justify-start items-center gap-8">
          <span>Fiil: <span class="italic">${verb}</span> (${verbs[verb].definition})</span>
          <span>Kök: <span class="italic">${root}</span></span>
        </h2>
        <div class="overflow-x-auto">
          <table class="min-w-full border border-blue-300 rounded-md text-sm">
            <thead class="bg-blue-100 text-blue-800">
              <tr>
                <th class="p-2 border border-blue-300 text-left">Kişi</th>
                <th class="p-2 border border-blue-300 text-left">Şimdiki Zaman</th>
                <th class="p-2 border border-blue-300 text-left">Olumsuz</th>
                <th class="p-2 border border-blue-300 text-left">Geçmiş Zaman</th>
                <th class="p-2 border border-blue-300 text-left">Gelecek Zaman</th>
              </tr>
            </thead>
            <tbody class="text-gray-700">
              ${persons.map((person, i) => `
                <tr>
                  <td class="p-2 border border-blue-200">${person}</td>
                  <td class="p-2">${v.present[i]}</td>
                  <td class="p-2">${v.presentNegative[i]}</td>
                  <td class="p-2">${v.past[i]}</td>
                  <td class="p-2">${v.future[i]}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    verbSelect.addEventListener("change", e => renderTable(e.target.value));
    searchInput.addEventListener("input", e => populateDropdown(e.target.value));
  </script>
</body>
</html>
