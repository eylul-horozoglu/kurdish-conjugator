<script>
  const persons = ["ez", "tu", "ew", "em", "hûn", "ew (pl.)"];
  const verbSelect = document.getElementById("verb-select");
  const searchInput = document.getElementById("verb-search");
  const conjugationContainer = document.getElementById("conjugation-container");

  let verbs = {};
  let searchIndex = [];

  fetch('Kurdish_Verbs.csv')
    .then(response => response.text())
    .then(csvText => {
      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      buildVerbsObject(parsed.data);
      buildSearchIndex();
      populateDropdown();
      renderTable(verbSelect.value);
    })
    .catch(err => {
      conjugationContainer.innerHTML = "<p class='text-red-600'>CSV dosyası yüklenirken hata oluştu.</p>";
      console.error("Error loading CSV:", err);
    });

  function normalize(str) {
    return str
      .toLowerCase()
      .normalize("NFD")               // Remove accents
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/ç/g, "c")
      .replace(/ş/g, "s")
      .replace(/î/g, "i")
      .replace(/ê/g, "e")
      .replace(/û/g, "u")
      .replace(/î/g, "i")
      .replace(/ê/g, "e")
      .replace(/û/g, "u");
  }

  function buildVerbsObject(data) {
    data.forEach(row => {
      verbs[row.verb] = {
        definition: row.definition,
        conjugations: {
          present: [
            row.present_1, row.present_2, row.present_3,
            row.present_4, row.present_5, row.present_6
          ],
          presentNegative: [
            row.presentNegative_1, row.presentNegative_2, row.presentNegative_3,
            row.presentNegative_4, row.presentNegative_5, row.presentNegative_6
          ],
          past: [
            row.past_1, row.past_2, row.past_3,
            row.past_4, row.past_5, row.past_6
          ],
          future: [
            row.future_1, row.future_2, row.future_3,
            row.future_4, row.future_5, row.future_6
          ]
        }
      };
    });
  }

  function buildSearchIndex() {
    searchIndex = [];

    for (const [verb, data] of Object.entries(verbs)) {
      const forms = new Set([
        verb,
        data.definition,
        ...data.conjugations.present,
        ...data.conjugations.presentNegative,
        ...data.conjugations.past,
        ...data.conjugations.future
      ]);

      forms.forEach(form => {
        if (form && form !== "—") {
          searchIndex.push({
            verb,
            definition: data.definition,
            match: normalize(form)
          });
        }
      });
    }
  }

  function populateDropdown(filter = "") {
    const query = normalize(filter);
    verbSelect.innerHTML = "";

    const matchedVerbs = new Set();

    if (query) {
      searchIndex.forEach(entry => {
        if (entry.match.includes(query)) {
          matchedVerbs.add(entry.verb);
        }
      });
    } else {
      Object.keys(verbs).forEach(v => matchedVerbs.add(v));
    }

    const matches = Array.from(matchedVerbs);

    if (matches.length === 0) {
      const option = document.createElement("option");
      option.textContent = "Eşleşen fiil bulunamadı.";
      option.disabled = true;
      verbSelect.appendChild(option);
      conjugationContainer.innerHTML = "";
      return;
    }

    matches.forEach((verb, index) => {
      const option = document.createElement("option");
      option.value = verb;
      option.textContent = `${verb} (${verbs[verb].definition})`;
      verbSelect.appendChild(option);
      if (index === 0) renderTable(verb);
    });
  }

  function renderTable(verb) {
    if (!verb || !verbs[verb]) {
      conjugationContainer.innerHTML = "<p>Fiil seçiniz.</p>";
      return;
    }
    const v = verbs[verb].conjugations;
    conjugationContainer.innerHTML = `
      <h2 class="text-xl font-semibold text-blue-700">
        Fiil: <span class="italic">${verb}</span> (${verbs[verb].definition})
      </h2>
      <div class="overflow-x-auto">
        <table class="min-w-full border border-blue-300 rounded-md text-sm">
          <thead class="bg-blue-100 text-blue-800">
            <tr>
              <th class="p-2 border border-blue-300 text-left">Kişi</th>
              <th class="p-2 border border-blue-300 text-left">Şimdiki Zaman</th>
              <th class="p-2 border border-blue-300 text-left">Olumsuz</th>
              <th class="p-2 border border-blue-300 text-left">Geçmiş Zaman</th>
              <th class="p-2 border border-blue-300 text-left">Gelecek Zaman</th>
            </tr>
          </thead>
          <tbody class="text-gray-700">
            ${persons.map((person, i) => `
              <tr>
                <td class="p-2 border border-blue-200">${person}</td>
                <td class="p-2">${v.present[i]}</td>
                <td class="p-2">${v.presentNegative[i]}</td>
                <td class="p-2">${v.past[i]}</td>
                <td class="p-2">${v.future[i]}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  verbSelect.addEventListener("change", e => renderTable(e.target.value));
  searchInput.addEventListener("input", e => populateDropdown(e.target.value));
</script>
